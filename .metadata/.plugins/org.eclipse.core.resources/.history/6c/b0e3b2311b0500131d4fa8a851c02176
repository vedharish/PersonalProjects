package com.vedharish.rsstosms;

import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URL;
import java.util.Scanner;

import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;

import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.impl.client.DefaultHttpClient;
import org.xml.sax.InputSource;
import org.xml.sax.XMLReader;

import android.os.AsyncTask;
import android.os.Bundle;
import android.telephony.SmsManager;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;
import android.app.Activity;
import android.app.PendingIntent;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;

public class SendSMSActivity extends Activity {
    Button buttonSendButton;
    EditText editTextPhoneNumber;
    EditText editTextMessage;
	
	@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_send_sms);
        
        buttonSendButton = (Button) findViewById(R.id.sendButton);
        editTextPhoneNumber = (EditText) findViewById(R.id.txtPhoneNumber);
        editTextMessage = (EditText) findViewById(R.id.txtMessage);
        
        buttonSendButton.setOnClickListener(new View.OnClickListener() {
			@Override
			public void onClick(View view) {
				String stringPhoneNumber = editTextPhoneNumber.getText().toString();
				String stringMessage = editTextMessage.getText().toString();
				
				if(stringPhoneNumber.length()>0 && stringMessage.length()>0){
					RetrieveURLContent urlContent = new RetrieveURLContent();
				    urlContent.execute(stringMessage, stringPhoneNumber);
				}else{
					Toast.makeText(getBaseContext(), "Please enter both phone number and message", Toast.LENGTH_SHORT).show();
				}
			}
		});
    }

	public void failedSMS(){
		Toast.makeText(getBaseContext(), "Failed SMS", Toast.LENGTH_LONG).show();
	}
	
	public void debugToast(int number){
		Toast.makeText(getBaseContext(), "while loop SMS "+number, Toast.LENGTH_LONG).show();
	}
}

class RetrieveURLContent extends AsyncTask<String, Void, Void> {
	@Override
	protected Void doInBackground(String... inputStringArray) {
		SendSMS sendSMSContent = new SendSMS();
		try{			
			URL tempUrl = new URL("http://api.androidhive.info/music/music.xml");
			SAXParserFactory saxFactory = SAXParserFactory.newInstance();
			SAXParser saxParser = saxFactory.newSAXParser();
			XMLReader xmlReader = saxParser.getXMLReader();
			RssHandler rssHandler = new RssHandler();
			xmlReader.setContentHandler(rssHandler);
			xmlReader.parse(new InputSource(tempUrl.openStream()));
			
			
//			HttpClient httpClient = new DefaultHttpClient();
//			HttpGet httpGetRequest = new HttpGet("http://api.androidhive.info/music/music.xml");
//			HttpResponse httpResponse = httpClient.execute(httpGetRequest);
//	    	InputStream tempInputStream = httpResponse.getEntity().getContent();
//	    	
//	    	sendSMSContent.execute(inputStringArray[1], convertStreamToString(tempInputStream));
		}catch(Exception e){
		}
		return null;
	}

	private String convertStreamToString(InputStream tempInputStream) {
		StringBuilder returnStringBuilder = new StringBuilder();
		BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(tempInputStream));
		String readLine = "";
		try{
			while((readLine = bufferedReader.readLine()) != null){
				returnStringBuilder.append(readLine);
			}
		}catch(Exception e){
			
		}
		return returnStringBuilder.toString();
	}
}

class SendSMS extends AsyncTask<String, Void, Void>{
	@Override
	protected Void doInBackground(String... inputArgumentsArray) {
//		String SENT = "SMS_SENT";
//        String DELIVERED = "SMS_DELIVERED";
        
//		PendingIntent sentPI = PendingIntent.getBroadcast(this, 0, new Intent(SENT), 0);
//	    PendingIntent deliveredPI = PendingIntent.getBroadcast(this, 0, new Intent(DELIVERED), 0);
//	    
//	    registerReceiver(new BroadcastReceiver(){
//	            @Override
//	            public void onReceive(Context arg0, Intent arg1) {
//	                switch (getResultCode())
//	                {
//	                    case Activity.RESULT_OK:
//	                        Toast.makeText(getBaseContext(), "SMS sent", Toast.LENGTH_SHORT).show();
//	                        break;
//	                    case SmsManager.RESULT_ERROR_GENERIC_FAILURE:
//	                        Toast.makeText(getBaseContext(), "Generic failure", Toast.LENGTH_SHORT).show();
//	                        break;
//	                    case SmsManager.RESULT_ERROR_NO_SERVICE:
//	                        Toast.makeText(getBaseContext(), "No service", Toast.LENGTH_SHORT).show();
//	                        break;
//	                    case SmsManager.RESULT_ERROR_NULL_PDU:
//	                        Toast.makeText(getBaseContext(), "Null PDU", Toast.LENGTH_SHORT).show();
//	                        break;
//	                    case SmsManager.RESULT_ERROR_RADIO_OFF:
//	                        Toast.makeText(getBaseContext(), "Radio off", Toast.LENGTH_SHORT).show();
//	                        break;
//	                }
//	            }
//
//	        }, new IntentFilter(SENT));
//	 
//        registerReceiver(new BroadcastReceiver(){
//            @Override
//            public void onReceive(Context arg0, Intent arg1) {
//                switch (getResultCode())
//                {
//                    case Activity.RESULT_OK:
//                        Toast.makeText(getBaseContext(), "SMS delivered", Toast.LENGTH_SHORT).show();
//                        break;
//                    case Activity.RESULT_CANCELED:
//                        Toast.makeText(getBaseContext(), "SMS not delivered", Toast.LENGTH_SHORT).show();
//                        break;                        
//                }
//            }
//        }, new IntentFilter(DELIVERED));
        SmsManager smsManager = SmsManager.getDefault();
        smsManager.sendTextMessage(inputArgumentsArray[0], null, inputArgumentsArray[1], null, null);

		return null;
	}
}